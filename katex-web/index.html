<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaTeXå…¬å¼ä¿®å¤åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            align-items: start;
        }

        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .results-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: #f7fafc;
            padding: 5px;
            border-radius: 8px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #718096;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-btn:hover:not(.active) {
            background: #edf2f7;
            color: #4a5568;
        }

        .mode-content {
            margin-bottom: 25px;
        }

        .folder-selection-methods {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .selection-method {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .selection-method:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .selection-method h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1rem;
        }

        .folder-upload-area,
        .files-upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }

        .folder-upload-area:hover,
        .files-upload-area:hover {
            border-color: #667eea;
            background-color: #f7fafc;
            transform: translateY(-2px);
        }

        .folder-upload-area.has-files,
        .files-upload-area.has-files {
            border-color: #48bb78;
            background-color: #f0fff4;
        }

        .path-examples {
            margin-top: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #6c757d;
        }

        .path-examples code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .selected-files-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .selected-files-info.show {
            display: block;
        }

        .files-count {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .files-list-preview {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .files-list-preview ul {
            margin: 0;
            padding-left: 20px;
        }

        .files-list-preview li {
            margin-bottom: 5px;
            color: #424242;
        }

        .folder-input-section,
        .text-input-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        .folder-path-input,
        .text-filename-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
            margin-bottom: 10px;
        }

        .folder-path-input:focus,
        .text-filename-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-input {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            font-family: 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .help-text {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #718096;
            font-style: italic;
        }

        .folder-results {
            margin-top: 20px;
        }

        .folder-summary {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .folder-summary.has-errors {
            background: #fff5f5;
            border-color: #fed7d7;
        }

        .folder-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .folder-stat {
            text-align: center;
        }

        .folder-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .folder-stat-label {
            font-size: 0.8rem;
            color: #718096;
        }

        .files-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .file-header {
            padding: 12px 15px;
            background: #f7fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .file-header:hover {
            background: #edf2f7;
        }

        .file-header.has-errors {
            background: #fed7d7;
        }

        .file-header.has-errors:hover {
            background: #feb2b2;
        }

        .file-name {
            font-weight: 600;
            color: #2d3748;
        }

        .file-stats {
            font-size: 0.85rem;
            color: #718096;
        }

        .file-content {
            display: none;
            padding: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .file-content.expanded {
            display: block;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background-color: #f7fafc;
        }

        .upload-icon {
            font-size: 3rem;
            color: #a0aec0;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #718096;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .options-section {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .check-btn {
            width: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .check-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .check-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .result-info {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .result-info.error {
            background: #fed7d7;
            border-color: #feb2b2;
            color: #c53030;
        }

        .result-info.success {
            color: #22543d;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #718096;
        }

        .stat-card.errors .stat-number {
            color: #e53e3e;
        }

        .stat-card.valid .stat-number {
            color: #38a169;
        }

        .stat-card.total .stat-number {
            color: #667eea;
        }

        .errors-list {
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .error-item {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .error-header {
            background: #fed7d7;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error-title {
            font-weight: 600;
            color: #c53030;
        }

        .error-type {
            background: #e53e3e;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .error-content {
            padding: 15px;
        }

        .formula-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
            font-size: 0.9rem;
            overflow-x: auto;
        }

        .error-message {
            color: #c53030;
            background: #fed7d7;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .correction-section {
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
            margin-top: 15px;
        }

        .correction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .correction-title {
            font-weight: 600;
            color: #2d3748;
        }

        .fix-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .fix-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .fix-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .correction-preview {
            display: none;
            margin-top: 15px;
        }

        .correction-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .comparison-side {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }

        .comparison-header {
            padding: 10px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .comparison-header.original {
            background: #fed7d7;
            color: #c53030;
        }

        .comparison-header.fixed {
            background: #c6f6d5;
            color: #22543d;
        }

        .comparison-content {
            padding: 12px;
            background: #f7fafc;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            min-height: 60px;
            overflow-x: auto;
        }

        .correction-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .accept-btn {
            background: #48bb78;
            color: white;
        }

        .reject-btn {
            background: #e53e3e;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .batch-actions {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .batch-btn {
            background: #38a169;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .batch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.4);
        }

        .batch-btn.danger {
            background: #e53e3e;
        }

        .batch-btn.danger:hover {
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.4);
        }

        .provider-selection {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .provider-radio {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .llm-config-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        
        .settings-btn {
            background: #4a5568;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        
        .settings-btn:hover {
            background: #2d3748;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.show {
            display: block;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: #667eea;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            opacity: 0.7;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .settings-tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 1rem;
            color: #4a5568;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        
        .tab-btn:hover {
            background: #f7fafc;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .config-group {
            margin-bottom: 20px;
        }
        
        .config-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .config-group input,
        .config-group select,
        .config-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }
        
        .config-group input:focus,
        .config-group select:focus,
        .config-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .config-group small {
            color: #718096;
            font-size: 0.8rem;
            margin-top: 5px;
            display: block;
        }
        
        .model-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .model-selector select {
            flex: 1;
        }
        
        .refresh-models-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        
        .refresh-models-btn:hover {
            background: #38a169;
        }
        
        .refresh-models-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .config-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f7fafc;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        .test-connection-btn {
            background: #3182ce;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }
        
        .test-connection-btn:hover {
            background: #2c5282;
        }
        
        .test-connection-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }
        
        .status-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-indicator.connected {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .status-indicator.disconnected {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .status-indicator.testing {
            background: #fefcbf;
            color: #744210;
        }
        
        .modal-footer {
            padding: 20px;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .no-errors {
            text-align: center;
            padding: 40px;
            color: #a0aec0;
        }

        .success-icon {
            font-size: 3rem;
            color: #48bb78;
            margin-bottom: 15px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .correction-comparison {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ LaTeXå…¬å¼ä¿®å¤åŠ©æ‰‹</h1>
            <p>æ™ºèƒ½æ£€æµ‹Markdownä¸­çš„æ•°å­¦å…¬å¼é”™è¯¯ | AIçº é”™ | ä¸€é”®ä¿®å¤</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <h2 class="section-title">
                    ğŸ“‚ é€‰æ‹©æ–‡ä»¶
                </h2>
                
                <!-- æ£€æµ‹æ¨¡å¼é€‰æ‹© -->
                <div class="mode-tabs">
                    <button class="tab-btn active" data-mode="file">ğŸ“„ å•ä¸ªæ–‡ä»¶</button>
                    <button class="tab-btn" data-mode="folder">ğŸ“ æ–‡ä»¶å¤¹æ‰¹é‡</button>
                    <button class="tab-btn" data-mode="text">ğŸ“ ç›´æ¥è¾“å…¥</button>
                </div>

                <!-- å•ä¸ªæ–‡ä»¶æ¨¡å¼ -->
                <div class="mode-content" id="file-mode">
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">ğŸ“„</div>
                        <div class="upload-text">
                            ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½Markdownæ–‡ä»¶åˆ°æ­¤å¤„<br>
                            æ”¯æŒ .md æ ¼å¼æ–‡ä»¶
                        </div>
                        <button class="upload-btn" type="button">é€‰æ‹©æ–‡ä»¶</button>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept=".md,.markdown" />
                </div>

                <!-- æ–‡ä»¶å¤¹æ¨¡å¼ -->
                <div class="mode-content" id="folder-mode" style="display: none;">
                    <div class="folder-selection-methods">
                        <!-- æ–¹æ³•1: æ–‡ä»¶å¤¹é€‰æ‹©å™¨ -->
                        <div class="selection-method">
                            <h4>ğŸ“ æ–¹æ³•ä¸€ï¼šé€‰æ‹©æ–‡ä»¶å¤¹</h4>
                            <div class="folder-upload-area" onclick="document.getElementById('folderInput').click()">
                                <div class="upload-icon">ğŸ“</div>
                                <div class="upload-text">
                                    ç‚¹å‡»é€‰æ‹©æ–‡ä»¶å¤¹<br>
                                    <small>å°†è¯»å–æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ .md æ–‡ä»¶</small>
                                </div>
                                <button class="upload-btn" type="button">é€‰æ‹©æ–‡ä»¶å¤¹</button>
                            </div>
                            <input type="file" id="folderInput" class="file-input" webkitdirectory multiple />
                            <p class="help-text">âœ… æ¨èï¼šç›´æ¥é€‰æ‹©åŒ…å«Markdownæ–‡ä»¶çš„æ–‡ä»¶å¤¹</p>
                        </div>

                        <!-- æ–¹æ³•2: å¤šæ–‡ä»¶é€‰æ‹© -->
                        <div class="selection-method">
                            <h4>ğŸ“„ æ–¹æ³•äºŒï¼šé€‰æ‹©å¤šä¸ªæ–‡ä»¶</h4>
                            <div class="files-upload-area" onclick="document.getElementById('multipleFilesInput').click()">
                                <div class="upload-icon">ğŸ“„</div>
                                <div class="upload-text">
                                    ç‚¹å‡»é€‰æ‹©å¤šä¸ª .md æ–‡ä»¶<br>
                                    <small>å¯åŒæ—¶é€‰æ‹©å¤šä¸ªMarkdownæ–‡ä»¶</small>
                                </div>
                                <button class="upload-btn" type="button">é€‰æ‹©å¤šä¸ªæ–‡ä»¶</button>
                            </div>
                            <input type="file" id="multipleFilesInput" class="file-input" accept=".md,.markdown" multiple />
                        </div>

                        <!-- æ–¹æ³•3: è·¯å¾„è¾“å…¥ -->
                        <div class="selection-method">
                            <h4>ğŸ“ æ–¹æ³•ä¸‰ï¼šæ‰‹åŠ¨è¾“å…¥è·¯å¾„</h4>
                            <div class="folder-input-section">
                                <div class="form-group">
                                    <label for="folderPath">æ–‡ä»¶å¤¹ç»å¯¹è·¯å¾„</label>
                                    <input type="text" id="folderPath" class="folder-path-input" 
                                           placeholder="ä¾‹å¦‚: C:\Users\ç”¨æˆ·å\Documents\markdown-files" />
                                    <div class="path-examples">
                                        <small>
                                            <strong>è·¯å¾„ç¤ºä¾‹ï¼š</strong><br>
                                            Windows: <code>C:\Users\ç”¨æˆ·å\Documents\my-docs</code><br>
                                            macOS/Linux: <code>/Users/ç”¨æˆ·å/Documents/my-docs</code>
                                        </small>
                                    </div>
                                </div>
                                <p class="help-text">âš ï¸ æ³¨æ„ï¼šéœ€è¦æœåŠ¡å™¨æœ‰è®¿é—®è¯¥è·¯å¾„çš„æƒé™</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ–‡æœ¬è¾“å…¥æ¨¡å¼ -->
                <div class="mode-content" id="text-mode" style="display: none;">
                    <div class="text-input-section">
                        <div class="form-group">
                            <label for="textInput">Markdownå†…å®¹</label>
                            <textarea id="textInput" class="text-input" 
                                      placeholder="è¯·è¾“å…¥è¦æ£€æŸ¥çš„Markdownå†…å®¹..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="textFilename">æ–‡ä»¶åï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" id="textFilename" class="text-filename-input" 
                                   placeholder="untitled.md" />
                        </div>
                    </div>
                </div>
                
                <div class="options-section">
                    <div class="form-group">
                        <label>LLM æä¾›å•†è®¾ç½®</label>
                        <div class="llm-config-container">
                            <!-- LLM æä¾›å•†é€‰æ‹© -->
                            <div class="provider-selection">
                                <div class="provider-radio">
                                    <input type="radio" id="lmstudio" name="provider" value="lmstudio" checked>
                                    <label for="lmstudio">LMStudio</label>
                                </div>
                                <div class="provider-radio">
                                    <input type="radio" id="ollama" name="provider" value="ollama">
                                    <label for="ollama">Ollama</label>
                                </div>
                                <div class="provider-radio">
                                    <input type="radio" id="openai" name="provider" value="openai">
                                    <label for="openai">OpenAI</label>
                                </div>
                            </div>
                            
                            <!-- è®¾ç½®æŒ‰é’® -->
                            <button type="button" class="settings-btn" id="settingsBtn">
                                âš™ï¸ è¯¦ç»†è®¾ç½®
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- LLM è®¾ç½®æ¨¡æ€æ¡† -->
                <div class="modal" id="settingsModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>LLM è¯¦ç»†è®¾ç½®</h3>
                            <span class="close" id="closeModal">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="settings-tabs">
                                <button class="tab-btn active" data-tab="lmstudio">LMStudio</button>
                                <button class="tab-btn" data-tab="ollama">Ollama</button>
                                <button class="tab-btn" data-tab="openai">OpenAI</button>
                            </div>
                            
                            <!-- LMStudio è®¾ç½® -->
                            <div class="tab-content active" id="tab-lmstudio">
                                <div class="config-group">
                                    <label for="lmstudio-endpoint">æœåŠ¡ç«¯ç‚¹</label>
                                    <input type="text" id="lmstudio-endpoint" value="http://localhost:1234" placeholder="http://localhost:1234">
                                </div>
                                <div class="config-group">
                                    <label for="lmstudio-model">æ¨¡å‹åç§°</label>
                                    <div class="model-selector">
                                        <select id="lmstudio-model">
                                            <option value="qwen/qwen3-4b-thinking-2507">qwen/qwen3-4b-thinking-2507</option>
                                        </select>
                                        <button type="button" class="refresh-models-btn" data-provider="lmstudio">ğŸ”„</button>
                                    </div>
                                </div>
                                <div class="config-group">
                                    <label for="lmstudio-prompt">ç³»ç»Ÿæç¤ºè¯</label>
                                    <textarea id="lmstudio-prompt" rows="3" placeholder="æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼">æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼</textarea>
                                </div>
                                <div class="config-status">
                                    <button type="button" class="test-connection-btn" data-provider="lmstudio">æµ‹è¯•è¿æ¥</button>
                                    <span class="status-indicator" id="lmstudio-status">æœªè¿æ¥</span>
                                </div>
                            </div>
                            
                            <!-- Ollama è®¾ç½® -->
                            <div class="tab-content" id="tab-ollama">
                                <div class="config-group">
                                    <label for="ollama-endpoint">æœåŠ¡ç«¯ç‚¹</label>
                                    <input type="text" id="ollama-endpoint" value="http://localhost:11434" placeholder="http://localhost:11434">
                                </div>
                                <div class="config-group">
                                    <label for="ollama-model">æ¨¡å‹åç§°</label>
                                    <div class="model-selector">
                                        <select id="ollama-model">
                                            <option value="qwen2.5:7b">qwen2.5:7b</option>
                                        </select>
                                        <button type="button" class="refresh-models-btn" data-provider="ollama">ğŸ”„</button>
                                    </div>
                                </div>
                                <div class="config-group">
                                    <label for="ollama-prompt">ç³»ç»Ÿæç¤ºè¯</label>
                                    <textarea id="ollama-prompt" rows="3" placeholder="æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼">æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼</textarea>
                                </div>
                                <div class="config-status">
                                    <button type="button" class="test-connection-btn" data-provider="ollama">æµ‹è¯•è¿æ¥</button>
                                    <span class="status-indicator" id="ollama-status">æœªè¿æ¥</span>
                                </div>
                            </div>
                            
                            <!-- OpenAI è®¾ç½® -->
                            <div class="tab-content" id="tab-openai">
                                <div class="config-group">
                                    <label for="openai-endpoint">æœåŠ¡ç«¯ç‚¹</label>
                                    <input type="text" id="openai-endpoint" value="https://api.openai.com" placeholder="https://api.openai.com">
                                </div>
                                <div class="config-group">
                                    <label for="openai-apikey">API Key</label>
                                    <input type="password" id="openai-apikey" placeholder="sk-...">
                                    <small>å°†ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­</small>
                                </div>
                                <div class="config-group">
                                    <label for="openai-model">æ¨¡å‹åç§°</label>
                                    <div class="model-selector">
                                        <select id="openai-model">
                                            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                            <option value="gpt-4">gpt-4</option>
                                            <option value="gpt-4-turbo">gpt-4-turbo</option>
                                        </select>
                                        <button type="button" class="refresh-models-btn" data-provider="openai">ğŸ”„</button>
                                    </div>
                                </div>
                                <div class="config-group">
                                    <label for="openai-prompt">ç³»ç»Ÿæç¤ºè¯</label>
                                    <textarea id="openai-prompt" rows="3" placeholder="æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼">æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼</textarea>
                                </div>
                                <div class="config-status">
                                    <button type="button" class="test-connection-btn" data-provider="openai">æµ‹è¯•è¿æ¥</button>
                                    <span class="status-indicator" id="openai-status">æœªè¿æ¥</span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" id="resetSettings">é‡ç½®è®¾ç½®</button>
                            <button type="button" class="btn-primary" id="saveSettings">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>
                
                <button class="check-btn" id="checkBtn" disabled>
                    ğŸ§  å¼€å§‹åˆ†æ
                </button>
                
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div class="result-info" id="resultInfo"></div>
            </div>

            <div class="results-section">
                <h2 class="section-title">
                    ğŸ” ä¿®å¤ç»“æœ
                </h2>
                
                <div class="summary-stats" id="summaryStats" style="display: none;">
                    <div class="stat-card total">
                        <div class="stat-number" id="totalFormulas">0</div>
                        <div class="stat-label">æ€»å…¬å¼æ•°</div>
                    </div>
                    <div class="stat-card valid">
                        <div class="stat-number" id="validFormulas">0</div>
                        <div class="stat-label">æ­£å¸¸å…¬å¼</div>
                    </div>
                    <div class="stat-card errors">
                        <div class="stat-number" id="errorFormulas">0</div>
                        <div class="stat-label">é”™è¯¯å…¬å¼</div>
                    </div>
                </div>

                <div class="batch-actions" id="batchActions" style="display: none;">
                    <h3 style="margin-bottom: 15px; color: #4a5568;">æ‰¹é‡æ“ä½œ</h3>
                    <button class="batch-btn" id="fixAllBtn">ğŸ”§ ä¸€é”®ä¿®å¤æ‰€æœ‰é”™è¯¯</button>
                    <button class="batch-btn" id="acceptAllBtn" style="display: none;">âœ… æ¥å—æ‰€æœ‰ä¿®æ­£</button>
                    <button class="batch-btn danger" id="rejectAllBtn" style="display: none;">âŒ æ‹’ç»æ‰€æœ‰ä¿®æ­£</button>
                </div>
                
                <div class="errors-list" id="errorsList">
                    <div class="no-errors">
                        <div>ç­‰å¾…æ–‡ä»¶åˆ†æ...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let currentResults = null;
        let corrections = {};
        let currentMode = 'file';
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.querySelector('.upload-area');
            const checkBtn = document.getElementById('checkBtn');

            // æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchMode(btn.dataset.mode));
            });

            // æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ–‡ä»¶å¤¹é€‰æ‹©
            document.getElementById('folderInput').addEventListener('change', handleFolderSelect);
            document.getElementById('multipleFilesInput').addEventListener('change', handleMultipleFilesSelect);
            
            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            
            // æ£€æµ‹æŒ‰é’®
            checkBtn.addEventListener('click', handleCheck);

            // æ–‡æœ¬è¾“å…¥ç›‘å¬
            document.getElementById('textInput').addEventListener('input', handleTextInput);
            document.getElementById('folderPath').addEventListener('input', handleFolderPathInput);

            // æ‰¹é‡æ“ä½œæŒ‰é’®
            document.getElementById('fixAllBtn').addEventListener('click', handleFixAll);
            document.getElementById('acceptAllBtn').addEventListener('click', handleAcceptAll);
            document.getElementById('rejectAllBtn').addEventListener('click', handleRejectAll);
            
            // LLMè®¾ç½®ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
            setupLLMSettingsEventListeners();
        }

        function switchMode(mode) {
            currentMode = mode;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // éšè—æ‰€æœ‰å†…å®¹
            document.querySelectorAll('.mode-content').forEach(content => {
                content.style.display = 'none';
            });

            // æ˜¾ç¤ºå½“å‰æ¨¡å¼å†…å®¹
            document.getElementById(`${mode}-mode`).style.display = 'block';

            // é‡ç½®çŠ¶æ€
            selectedFile = null;
            currentResults = null;
            corrections = {};
            window.selectedFolderFiles = null;
            resetCheckButton();
            clearResults();
            
            // é‡ç½®æ‰€æœ‰è¾“å…¥
            document.getElementById('fileInput').value = '';
            document.getElementById('folderInput').value = '';
            document.getElementById('multipleFilesInput').value = '';
            document.getElementById('folderPath').value = '';
            document.getElementById('textInput').value = '';
            document.getElementById('textFilename').value = '';
            
            // é‡ç½®ä¸Šä¼ åŒºåŸŸæ˜¾ç¤º
            resetUploadAreas();
        }

        function resetUploadAreas() {
            // é‡ç½®å•æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            const uploadArea = document.querySelector('#file-mode .upload-area');
            if (uploadArea) {
                uploadArea.innerHTML = `
                    <div class="upload-icon">ğŸ“„</div>
                    <div class="upload-text">
                        ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½Markdownæ–‡ä»¶åˆ°æ­¤å¤„<br>
                        æ”¯æŒ .md æ ¼å¼æ–‡ä»¶
                    </div>
                    <button class="upload-btn" type="button">é€‰æ‹©æ–‡ä»¶</button>
                `;
            }

            // é‡ç½®æ–‡ä»¶å¤¹ä¸Šä¼ åŒºåŸŸ
            const folderUploadArea = document.querySelector('.folder-upload-area');
            if (folderUploadArea) {
                folderUploadArea.classList.remove('has-files');
                folderUploadArea.innerHTML = `
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">
                        ç‚¹å‡»é€‰æ‹©æ–‡ä»¶å¤¹<br>
                        <small>å°†è¯»å–æ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰ .md æ–‡ä»¶</small>
                    </div>
                    <button class="upload-btn" type="button">é€‰æ‹©æ–‡ä»¶å¤¹</button>
                `;
            }

            // é‡ç½®å¤šæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            const filesUploadArea = document.querySelector('.files-upload-area');
            if (filesUploadArea) {
                filesUploadArea.classList.remove('has-files');
                filesUploadArea.innerHTML = `
                    <div class="upload-icon">ğŸ“„</div>
                    <div class="upload-text">
                        ç‚¹å‡»é€‰æ‹©å¤šä¸ª .md æ–‡ä»¶<br>
                        <small>å¯åŒæ—¶é€‰æ‹©å¤šä¸ªMarkdownæ–‡ä»¶</small>
                    </div>
                    <button class="upload-btn" type="button">é€‰æ‹©å¤šä¸ªæ–‡ä»¶</button>
                `;
            }

            // éšè—æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
            document.querySelectorAll('.selected-files-info').forEach(info => {
                info.classList.remove('show');
            });
        }

        function handleTextInput() {
            const textInput = document.getElementById('textInput');
            const checkBtn = document.getElementById('checkBtn');
            checkBtn.disabled = !textInput.value.trim();
        }

        function handleFolderPathInput() {
            const folderInput = document.getElementById('folderPath');
            const checkBtn = document.getElementById('checkBtn');
            const inputValue = folderInput.value.trim();
            
            // é‡ç½®é€‰æ‹©å™¨é€‰æ‹©çš„æ–‡ä»¶
            window.selectedFolderFiles = null;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è¾“å…¥è·¯å¾„
            checkBtn.disabled = !inputValue;
            
            // å®æ—¶è·¯å¾„éªŒè¯æç¤º
            const pathExamples = folderInput.parentElement.querySelector('.path-examples');
            if (inputValue) {
                // ç®€å•çš„è·¯å¾„æ ¼å¼éªŒè¯
                const isWindowsPath = /^[A-Za-z]:\\/.test(inputValue);
                const isUnixPath = /^\//.test(inputValue);
                const isRelativePath = /^[^\/\\]/.test(inputValue) && !isWindowsPath;
                
                let validationMessage = '';
                if (isRelativePath) {
                    validationMessage = '<span style="color: #e53e3e;">âš ï¸ å»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„</span><br>';
                } else if (isWindowsPath || isUnixPath) {
                    validationMessage = '<span style="color: #38a169;">âœ… è·¯å¾„æ ¼å¼æ­£ç¡®</span><br>';
                }
                
                pathExamples.innerHTML = `
                    <small>
                        ${validationMessage}
                        <strong>è·¯å¾„ç¤ºä¾‹ï¼š</strong><br>
                        Windows: <code>C:\\Users\\ç”¨æˆ·å\\Documents\\my-docs</code><br>
                        macOS/Linux: <code>/Users/ç”¨æˆ·å/Documents/my-docs</code>
                    </small>
                `;
            } else {
                pathExamples.innerHTML = `
                    <small>
                        <strong>è·¯å¾„ç¤ºä¾‹ï¼š</strong><br>
                        Windows: <code>C:\\Users\\ç”¨æˆ·å\\Documents\\my-docs</code><br>
                        macOS/Linux: <code>/Users/ç”¨æˆ·å/Documents/my-docs</code>
                    </small>
                `;
            }
        }

        function selectFolder() {
            // ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥é€‰æ‹©æ–‡ä»¶å¤¹
            // æç¤ºç”¨æˆ·æ‰‹åŠ¨è¾“å…¥è·¯å¾„
            const folderInput = document.getElementById('folderPath');
            folderInput.focus();
            showResult('info', 'è¯·æ‰‹åŠ¨è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„ã€‚æ³¨æ„ï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥é€‰æ‹©æ–‡ä»¶å¤¹ã€‚');
        }

        function resetCheckButton() {
            const checkBtn = document.getElementById('checkBtn');
            checkBtn.disabled = true;
            checkBtn.textContent = 'ğŸ§  å¼€å§‹åˆ†æ';
        }

        function clearResults() {
            document.getElementById('summaryStats').style.display = 'none';
            document.getElementById('batchActions').style.display = 'none';
            document.getElementById('errorsList').innerHTML = `
                <div class="no-errors">
                    <div>ç­‰å¾…åˆ†æ...</div>
                </div>
            `;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                updateUploadArea(file.name);
                document.getElementById('checkBtn').disabled = false;
            }
        }

        function handleFolderSelect(event) {
            const files = Array.from(event.target.files);
            const mdFiles = files.filter(file => 
                file.name.endsWith('.md') || file.name.endsWith('.markdown')
            );
            
            if (mdFiles.length > 0) {
                updateFolderSelectionDisplay('folderInput', mdFiles);
                document.getElementById('checkBtn').disabled = false;
                
                // å­˜å‚¨é€‰ä¸­çš„æ–‡ä»¶ä»¥ä¾¿åç»­å¤„ç†
                window.selectedFolderFiles = mdFiles;
            } else {
                showResult('error', 'æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°Markdownæ–‡ä»¶');
            }
        }

        function handleMultipleFilesSelect(event) {
            const files = Array.from(event.target.files);
            const mdFiles = files.filter(file => 
                file.name.endsWith('.md') || file.name.endsWith('.markdown')
            );
            
            if (mdFiles.length > 0) {
                updateFolderSelectionDisplay('multipleFilesInput', mdFiles);
                document.getElementById('checkBtn').disabled = false;
                
                // å­˜å‚¨é€‰ä¸­çš„æ–‡ä»¶ä»¥ä¾¿åç»­å¤„ç†
                window.selectedFolderFiles = mdFiles;
            } else {
                showResult('error', 'è¯·é€‰æ‹©Markdownæ–‡ä»¶(.md)');
            }
        }

        function updateFolderSelectionDisplay(inputId, files) {
            const uploadArea = document.querySelector(`#${inputId}`).parentElement.querySelector('.folder-upload-area, .files-upload-area');
            uploadArea.classList.add('has-files');
            
            uploadArea.innerHTML = `
                <div class="upload-icon">âœ…</div>
                <div class="upload-text">
                    å·²é€‰æ‹© ${files.length} ä¸ªMarkdownæ–‡ä»¶<br>
                    ç‚¹å‡»å¯é‡æ–°é€‰æ‹©
                </div>
            `;

            // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            const selectionMethod = uploadArea.closest('.selection-method');
            let filesInfo = selectionMethod.querySelector('.selected-files-info');
            if (!filesInfo) {
                filesInfo = document.createElement('div');
                filesInfo.className = 'selected-files-info';
                selectionMethod.appendChild(filesInfo);
            }
            
            filesInfo.innerHTML = `
                <div class="files-count">å…±é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶ï¼š</div>
                <div class="files-list-preview">
                    <ul>
                        ${files.slice(0, 10).map(file => `<li>${file.webkitRelativePath || file.name}</li>`).join('')}
                        ${files.length > 10 ? `<li>... è¿˜æœ‰ ${files.length - 10} ä¸ªæ–‡ä»¶</li>` : ''}
                    </ul>
                </div>
            `;
            filesInfo.classList.add('show');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.md') || file.name.endsWith('.markdown')) {
                    selectedFile = file;
                    updateUploadArea(file.name);
                    document.getElementById('checkBtn').disabled = false;
                } else {
                    showResult('error', 'è¯·é€‰æ‹©Markdownæ–‡ä»¶(.md)');
                }
            }
        }

        function updateUploadArea(filename) {
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.innerHTML = `
                <div class="upload-icon">âœ…</div>
                <div class="upload-text">
                    å·²é€‰æ‹©æ–‡ä»¶: <strong>${filename}</strong><br>
                    ç‚¹å‡»å¯é‡æ–°é€‰æ‹©æ–‡ä»¶
                </div>
            `;
        }

        async function handleCheck() {
            if (currentMode === 'file') {
                await handleFileCheck();
            } else if (currentMode === 'folder') {
                await handleFolderCheck();
            } else if (currentMode === 'text') {
                await handleTextCheck();
            }
        }

        async function handleFileCheck() {
            if (!selectedFile) {
                showResult('error', 'è¯·é€‰æ‹©Markdownæ–‡ä»¶');
                return;
            }

            const checkBtn = document.getElementById('checkBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');

            // æ˜¾ç¤ºè¿›åº¦æ¡
            checkBtn.disabled = true;
            checkBtn.textContent = 'ğŸ”„ åˆ†æä¸­...';
            progressBar.style.display = 'block';
            progressFill.style.width = '30%';

            try {
                const formData = new FormData();
                formData.append('markdown', selectedFile);
                
                progressFill.style.width = '60%';

                const response = await fetch('/check', {
                    method: 'POST',
                    body: formData
                });

                progressFill.style.width = '90%';

                const result = await response.json();

                if (result.success) {
                    progressFill.style.width = '100%';
                    currentResults = result.results;
                    corrections = {};
                    displayResults(result.results);
                    showResult('success', `åˆ†æå®Œæˆï¼å…±åˆ†æ ${result.results.totalFormulas} ä¸ªå…¬å¼ï¼Œå‘ç° ${result.results.errors.length} ä¸ªé”™è¯¯`);
                } else {
                    throw new Error(result.message || 'åˆ†æå¤±è´¥');
                }

            } catch (error) {
                showResult('error', 'åˆ†æå¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    checkBtn.disabled = false;
                    checkBtn.textContent = 'ğŸ§  å¼€å§‹åˆ†æ';
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);
            }
        }

        async function handleFolderCheck() {
            // æ£€æŸ¥æ˜¯å¦æœ‰é€šè¿‡æ–‡ä»¶é€‰æ‹©å™¨é€‰æ‹©çš„æ–‡ä»¶
            if (window.selectedFolderFiles && window.selectedFolderFiles.length > 0) {
                await handleFilesArrayCheck();
                return;
            }

            // å¦åˆ™ä½¿ç”¨è·¯å¾„è¾“å…¥çš„æ–¹å¼
            const folderPath = document.getElementById('folderPath').value.trim();
            if (!folderPath) {
                showResult('error', 'è¯·é€‰æ‹©æ–‡ä»¶å¤¹æˆ–è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„');
                return;
            }

            const checkBtn = document.getElementById('checkBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');

            checkBtn.disabled = true;
            checkBtn.textContent = 'ğŸ”„ æ‰¹é‡åˆ†æä¸­...';
            progressBar.style.display = 'block';
            progressFill.style.width = '30%';

            try {
                progressFill.style.width = '60%';

                const response = await fetch('/check-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ folderPath })
                });

                progressFill.style.width = '90%';

                const result = await response.json();

                if (result.success) {
                    progressFill.style.width = '100%';
                    currentResults = result.results;
                    corrections = {};
                    displayFolderResults(result.results);
                    showResult('success', `æ–‡ä»¶å¤¹åˆ†æå®Œæˆï¼å…±åˆ†æ ${result.results.totalFiles} ä¸ªæ–‡ä»¶ï¼Œ${result.results.totalFormulas} ä¸ªå…¬å¼ï¼Œå‘ç° ${result.results.totalErrors} ä¸ªé”™è¯¯`);
                } else {
                    throw new Error(result.message || 'æ–‡ä»¶å¤¹åˆ†æå¤±è´¥');
                }

            } catch (error) {
                showResult('error', 'æ–‡ä»¶å¤¹åˆ†æå¤±è´¥: ' + error.message);
            } finally {
                setTimeout(() => {
                    checkBtn.disabled = false;
                    checkBtn.textContent = 'ğŸ§  å¼€å§‹åˆ†æ';
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);
            }
        }

        async function handleFilesArrayCheck() {
            const files = window.selectedFolderFiles;
            const checkBtn = document.getElementById('checkBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');

            checkBtn.disabled = true;
            checkBtn.textContent = 'ğŸ”„ æ‰¹é‡åˆ†æä¸­...';
            progressBar.style.display = 'block';
            progressFill.style.width = '30%';

            try {
                const results = {
                    folderPath: 'æµè§ˆå™¨é€‰æ‹©çš„æ–‡ä»¶',
                    totalFiles: files.length,
                    processedFiles: 0,
                    filesWithErrors: 0,
                    totalFormulas: 0,
                    totalErrors: 0,
                    files: []
                };

                // å¤„ç†æ¯ä¸ªæ–‡ä»¶
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const content = await readFileAsText(file);
                    const fileResult = await checkFileContent(content, file.webkitRelativePath || file.name);
                    
                    results.files.push({
                        path: file.webkitRelativePath || file.name,
                        fullPath: file.webkitRelativePath || file.name,
                        ...fileResult
                    });
                    
                    results.processedFiles++;
                    results.totalFormulas += fileResult.totalFormulas;
                    results.totalErrors += fileResult.errors.length;
                    
                    if (fileResult.hasErrors) {
                        results.filesWithErrors++;
                    }

                    // æ›´æ–°è¿›åº¦
                    const progress = 30 + (i + 1) / files.length * 60;
                    progressFill.style.width = progress + '%';
                }

                progressFill.style.width = '100%';
                currentResults = results;
                corrections = {};
                displayFolderResults(results);
                showResult('success', `æ–‡ä»¶åˆ†æå®Œæˆï¼å…±åˆ†æ ${results.totalFiles} ä¸ªæ–‡ä»¶ï¼Œ${results.totalFormulas} ä¸ªå…¬å¼ï¼Œå‘ç° ${results.totalErrors} ä¸ªé”™è¯¯`);

            } catch (error) {
                showResult('error', 'æ–‡ä»¶åˆ†æå¤±è´¥: ' + error.message);
            } finally {
                setTimeout(() => {
                    checkBtn.disabled = false;
                    checkBtn.textContent = 'ğŸ§  å¼€å§‹åˆ†æ';
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function checkFileContent(content, filename) {
            const response = await fetch('/check-text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    content: content,
                    filename: filename
                })
            });

            const result = await response.json();
            if (result.success) {
                return result.results;
            } else {
                throw new Error(result.message || 'æ£€æµ‹å¤±è´¥');
            }
        }

        async function handleTextCheck() {
            const textContent = document.getElementById('textInput').value.trim();
            const filename = document.getElementById('textFilename').value.trim() || 'untitled.md';
            
            if (!textContent) {
                showResult('error', 'è¯·è¾“å…¥Markdownå†…å®¹');
                return;
            }

            const checkBtn = document.getElementById('checkBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');

            checkBtn.disabled = true;
            checkBtn.textContent = 'ğŸ”„ åˆ†æä¸­...';
            progressBar.style.display = 'block';
            progressFill.style.width = '30%';

            try {
                progressFill.style.width = '60%';

                const response = await fetch('/check-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: textContent,
                        filename: filename
                    })
                });

                progressFill.style.width = '90%';

                const result = await response.json();

                if (result.success) {
                    progressFill.style.width = '100%';
                    currentResults = result.results;
                    corrections = {};
                    displayResults(result.results);
                    showResult('success', `åˆ†æå®Œæˆï¼å…±åˆ†æ ${result.results.totalFormulas} ä¸ªå…¬å¼ï¼Œå‘ç° ${result.results.errors.length} ä¸ªé”™è¯¯`);
                } else {
                    throw new Error(result.message || 'åˆ†æå¤±è´¥');
                }

            } catch (error) {
                showResult('error', 'åˆ†æå¤±è´¥: ' + error.message);
            } finally {
                setTimeout(() => {
                    checkBtn.disabled = false;
                    checkBtn.textContent = 'ğŸ§  å¼€å§‹åˆ†æ';
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                }, 1000);
            }
        }

        function displayFolderResults(results) {
            // æ›´æ–°æ€»ä½“ç»Ÿè®¡
            document.getElementById('totalFormulas').textContent = results.totalFormulas;
            document.getElementById('validFormulas').textContent = results.totalFormulas - results.totalErrors;
            document.getElementById('errorFormulas').textContent = results.totalErrors;
            document.getElementById('summaryStats').style.display = 'grid';

            // æ˜¾ç¤ºæ‰¹é‡æ“ä½œ
            if (results.totalErrors > 0) {
                document.getElementById('batchActions').style.display = 'block';
                document.getElementById('fixAllBtn').style.display = 'inline-block';
            } else {
                document.getElementById('batchActions').style.display = 'none';
            }

            // æ˜¾ç¤ºæ–‡ä»¶å¤¹ç»“æœ
            const errorsList = document.getElementById('errorsList');
            
            if (results.totalErrors === 0) {
                errorsList.innerHTML = `
                    <div class="no-errors">
                        <div class="success-icon">ğŸ‰</div>
                        <div>æ‰€æœ‰æ–‡ä»¶éƒ½æ­£å¸¸ï¼æœªå‘ç°é”™è¯¯ã€‚</div>
                    </div>
                `;
                return;
            }

            errorsList.innerHTML = `
                <div class="folder-results">
                    <div class="folder-summary ${results.totalErrors > 0 ? 'has-errors' : ''}">
                        <div class="folder-stats">
                            <div class="folder-stat">
                                <div class="folder-stat-number">${results.totalFiles}</div>
                                <div class="folder-stat-label">æ€»æ–‡ä»¶æ•°</div>
                            </div>
                            <div class="folder-stat">
                                <div class="folder-stat-number">${results.processedFiles}</div>
                                <div class="folder-stat-label">å·²å¤„ç†</div>
                            </div>
                            <div class="folder-stat">
                                <div class="folder-stat-number">${results.filesWithErrors}</div>
                                <div class="folder-stat-label">æœ‰é”™è¯¯æ–‡ä»¶</div>
                            </div>
                        </div>
                        <p style="margin: 0; color: #4a5568;">æ–‡ä»¶å¤¹: ${results.folderPath}</p>
                    </div>
                    
                    <div class="files-list">
                        ${results.files.map((file, index) => `
                            <div class="file-item">
                                <div class="file-header ${file.hasErrors ? 'has-errors' : ''}" onclick="toggleFileContent(${index})">
                                    <div class="file-name">${file.path}</div>
                                    <div class="file-stats">
                                        ${file.totalFormulas} å…¬å¼ | ${file.errors.length} é”™è¯¯
                                    </div>
                                </div>
                                <div class="file-content" id="file-content-${index}">
                                    ${file.hasErrors ? renderFileErrors(file, index) : '<p style="color: #22543d;">âœ… æ­¤æ–‡ä»¶æ²¡æœ‰é”™è¯¯</p>'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderFileErrors(file, fileIndex) {
            return file.errors.map((error, errorIndex) => `
                <div class="error-item" id="file-${fileIndex}-error-${errorIndex}">
                    <div class="error-header">
                        <div class="error-title">å…¬å¼é”™è¯¯ #${errorIndex + 1}</div>
                        <div class="error-type">${error.type}</div>
                    </div>
                    <div class="error-content">
                        <div class="formula-display">${escapeHtml(error.raw)}</div>
                        <div class="error-message">${escapeHtml(error.error)}</div>
                        
                        <div class="correction-section">
                            <div class="correction-header">
                                <div class="correction-title">LLM æ™ºèƒ½çº é”™</div>
                                <button class="fix-btn" onclick="fixFileFormula(${fileIndex}, ${errorIndex})">ğŸ”§ è·å–ä¿®æ­£å»ºè®®</button>
                            </div>
                            <div class="correction-preview" id="file-${fileIndex}-correction-${errorIndex}">
                                <!-- ä¿®æ­£é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleFileContent(index) {
            const content = document.getElementById(`file-content-${index}`);
            content.classList.toggle('expanded');
        }

        async function fixFileFormula(fileIndex, errorIndex) {
            const file = currentResults.files[fileIndex];
            const error = file.errors[errorIndex];
            const provider = document.querySelector('input[name="provider"]:checked').value;
            const providerConfig = getCurrentProviderConfig();
            const fixBtn = document.querySelector(`#file-${fileIndex}-error-${errorIndex} .fix-btn`);
            
            fixBtn.disabled = true;
            fixBtn.textContent = 'ğŸ”„ ä¿®æ­£ä¸­...';

            try {
                const response = await fetch('/fix-formula', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        formula: error.content,
                        error: error.error,
                        provider: provider,
                        config: providerConfig.config
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const correctionKey = `${fileIndex}-${errorIndex}`;
                    corrections[correctionKey] = result;
                    displayFileCorrection(fileIndex, errorIndex, result);
                    fixBtn.style.display = 'none';
                } else {
                    throw new Error(result.message || 'ä¿®æ­£å¤±è´¥');
                }

            } catch (error) {
                showResult('error', 'ä¿®æ­£å¤±è´¥: ' + error.message);
                fixBtn.disabled = false;
                fixBtn.textContent = 'ğŸ”§ è·å–ä¿®æ­£å»ºè®®';
            }
        }

        function displayFileCorrection(fileIndex, errorIndex, result) {
            const correctionDiv = document.getElementById(`file-${fileIndex}-correction-${errorIndex}`);
            
            correctionDiv.innerHTML = `
                <div class="correction-comparison">
                    <div class="comparison-side">
                        <div class="comparison-header original">åŸå§‹å…¬å¼</div>
                        <div class="comparison-content">${escapeHtml(result.original)}</div>
                    </div>
                    <div class="comparison-side">
                        <div class="comparison-header fixed">ä¿®æ­£å»ºè®®</div>
                        <div class="comparison-content">${escapeHtml(result.fixed)}</div>
                    </div>
                </div>
                <div class="correction-actions">
                    <button class="action-btn accept-btn" onclick="acceptFileCorrection(${fileIndex}, ${errorIndex})">âœ… æ¥å—ä¿®æ­£</button>
                    <button class="action-btn reject-btn" onclick="rejectFileCorrection(${fileIndex}, ${errorIndex})">âŒ æ‹’ç»ä¿®æ­£</button>
                </div>
            `;
            
            correctionDiv.style.display = 'block';
            
            // æ˜¾ç¤ºæ¥å—/æ‹’ç»å…¨éƒ¨æŒ‰é’®
            document.getElementById('acceptAllBtn').style.display = 'inline-block';
            document.getElementById('rejectAllBtn').style.display = 'inline-block';
        }

        function acceptFileCorrection(fileIndex, errorIndex) {
            const errorItem = document.getElementById(`file-${fileIndex}-error-${errorIndex}`);
            errorItem.style.border = '2px solid #48bb78';
            errorItem.style.background = '#f0fff4';
            
            const correctionDiv = document.getElementById(`file-${fileIndex}-correction-${errorIndex}`);
            correctionDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #22543d; background: #c6f6d5; border-radius: 6px;">
                    âœ… å·²æ¥å—æ­¤ä¿®æ­£å»ºè®®
                </div>
            `;
            
            const correctionKey = `${fileIndex}-${errorIndex}`;
            corrections[correctionKey].accepted = true;
            updateApplyButton();
        }

        function rejectFileCorrection(fileIndex, errorIndex) {
            const errorItem = document.getElementById(`file-${fileIndex}-error-${errorIndex}`);
            errorItem.style.border = '2px solid #e53e3e';
            errorItem.style.background = '#fff5f5';
            
            const correctionDiv = document.getElementById(`file-${fileIndex}-correction-${errorIndex}`);
            correctionDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #c53030; background: #fed7d7; border-radius: 6px;">
                    âŒ å·²æ‹’ç»æ­¤ä¿®æ­£å»ºè®®
                </div>
            `;
            
            const correctionKey = `${fileIndex}-${errorIndex}`;
            corrections[correctionKey].accepted = false;
            updateApplyButton();
        }

        function displayResults(results) {
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('totalFormulas').textContent = results.totalFormulas;
            document.getElementById('validFormulas').textContent = results.validFormulas;
            document.getElementById('errorFormulas').textContent = results.errors.length;
            document.getElementById('summaryStats').style.display = 'grid';

            // æ˜¾ç¤ºæ‰¹é‡æ“ä½œ
            if (results.errors.length > 0) {
                document.getElementById('batchActions').style.display = 'block';
                document.getElementById('fixAllBtn').style.display = 'inline-block';
            } else {
                document.getElementById('batchActions').style.display = 'none';
            }

            // æ˜¾ç¤ºé”™è¯¯åˆ—è¡¨
            const errorsList = document.getElementById('errorsList');
            
            if (results.errors.length === 0) {
                errorsList.innerHTML = `
                    <div class="no-errors">
                        <div class="success-icon">ğŸ‰</div>
                        <div>æ‰€æœ‰å…¬å¼éƒ½æ­£å¸¸ï¼æœªå‘ç°é”™è¯¯ã€‚</div>
                    </div>
                `;
                return;
            }

            errorsList.innerHTML = results.errors.map((error, index) => `
                <div class="error-item" id="error-${index}">
                    <div class="error-header">
                        <div class="error-title">å…¬å¼é”™è¯¯ #${index + 1}</div>
                        <div class="error-type">${error.type}</div>
                    </div>
                    <div class="error-content">
                        <div class="formula-display">${escapeHtml(error.raw)}</div>
                        <div class="error-message">${escapeHtml(error.error)}</div>
                        
                        <div class="correction-section">
                            <div class="correction-header">
                                <div class="correction-title">LLM æ™ºèƒ½çº é”™</div>
                                <button class="fix-btn" onclick="fixFormula(${index})">ğŸ”§ è·å–ä¿®æ­£å»ºè®®</button>
                            </div>
                            <div class="correction-preview" id="correction-${index}">
                                <!-- ä¿®æ­£é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function fixFormula(index) {
            const error = currentResults.errors[index];
            const provider = document.querySelector('input[name="provider"]:checked').value;
            const providerConfig = getCurrentProviderConfig();
            const fixBtn = document.querySelector(`#error-${index} .fix-btn`);
            
            fixBtn.disabled = true;
            fixBtn.textContent = 'ğŸ”„ ä¿®æ­£ä¸­...';

            try {
                const response = await fetch('/fix-formula', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        formula: error.content,
                        error: error.error,
                        provider: provider,
                        config: providerConfig.config
                    })
                });

                const result = await response.json();

                if (result.success) {
                    corrections[index] = result;
                    displayCorrection(index, result);
                    fixBtn.style.display = 'none';
                } else {
                    throw new Error(result.message || 'ä¿®æ­£å¤±è´¥');
                }

            } catch (error) {
                showResult('error', 'ä¿®æ­£å¤±è´¥: ' + error.message);
                fixBtn.disabled = false;
                fixBtn.textContent = 'ğŸ”§ è·å–ä¿®æ­£å»ºè®®';
            }
        }

        function displayCorrection(index, result) {
            const correctionDiv = document.getElementById(`correction-${index}`);
            
            correctionDiv.innerHTML = `
                <div class="correction-comparison">
                    <div class="comparison-side">
                        <div class="comparison-header original">åŸå§‹å…¬å¼</div>
                        <div class="comparison-content">${escapeHtml(result.original)}</div>
                    </div>
                    <div class="comparison-side">
                        <div class="comparison-header fixed">ä¿®æ­£å»ºè®®</div>
                        <div class="comparison-content">${escapeHtml(result.fixed)}</div>
                    </div>
                </div>
                <div class="correction-actions">
                    <button class="action-btn accept-btn" onclick="acceptCorrection(${index})">âœ… æ¥å—ä¿®æ­£</button>
                    <button class="action-btn reject-btn" onclick="rejectCorrection(${index})">âŒ æ‹’ç»ä¿®æ­£</button>
                </div>
            `;
            
            correctionDiv.style.display = 'block';
            
            // æ˜¾ç¤ºæ¥å—/æ‹’ç»å…¨éƒ¨æŒ‰é’®
            document.getElementById('acceptAllBtn').style.display = 'inline-block';
            document.getElementById('rejectAllBtn').style.display = 'inline-block';
        }

        function acceptCorrection(index) {
            const errorItem = document.getElementById(`error-${index}`);
            errorItem.style.border = '2px solid #48bb78';
            errorItem.style.background = '#f0fff4';
            
            const correctionDiv = document.getElementById(`correction-${index}`);
            correctionDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #22543d; background: #c6f6d5; border-radius: 6px;">
                    âœ… å·²æ¥å—æ­¤ä¿®æ­£å»ºè®®
                </div>
            `;
            
            corrections[index].accepted = true;
            updateApplyButton();
        }

        function rejectCorrection(index) {
            const errorItem = document.getElementById(`error-${index}`);
            errorItem.style.border = '2px solid #e53e3e';
            errorItem.style.background = '#fff5f5';
            
            const correctionDiv = document.getElementById(`correction-${index}`);
            correctionDiv.innerHTML = `
                <div style="text-align: center; padding: 20px; color: #c53030; background: #fed7d7; border-radius: 6px;">
                    âŒ å·²æ‹’ç»æ­¤ä¿®æ­£å»ºè®®
                </div>
            `;
            
            corrections[index].accepted = false;
            updateApplyButton();
        }

        async function handleFixAll() {
            const errors = currentResults.errors;
            const provider = document.querySelector('input[name="provider"]:checked').value;
            const fixAllBtn = document.getElementById('fixAllBtn');
            
            fixAllBtn.disabled = true;
            fixAllBtn.textContent = 'ğŸ”„ æ‰¹é‡ä¿®æ­£ä¸­...';

            try {
                const response = await fetch('/fix-batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        errors: errors.map((error, index) => ({
                            id: index,
                            formula: error.content,
                            error: error.error
                        })),
                        provider: provider
                    })
                });

                const result = await response.json();

                if (result.success) {
                    result.results.forEach(correction => {
                        if (correction.success) {
                            corrections[correction.id] = {
                                original: correction.original,
                                fixed: correction.fixed,
                                validation: correction.validation
                            };
                            displayCorrection(correction.id, corrections[correction.id]);
                        }
                    });
                    
                    showResult('success', `æ‰¹é‡ä¿®æ­£å®Œæˆï¼æˆåŠŸä¿®æ­£ ${result.results.filter(r => r.success).length} ä¸ªå…¬å¼`);
                } else {
                    throw new Error(result.message || 'æ‰¹é‡ä¿®æ­£å¤±è´¥');
                }

            } catch (error) {
                showResult('error', 'æ‰¹é‡ä¿®æ­£å¤±è´¥: ' + error.message);
            } finally {
                fixAllBtn.disabled = false;
                fixAllBtn.textContent = 'ğŸ”§ ä¸€é”®ä¿®å¤æ‰€æœ‰é”™è¯¯';
            }
        }

        function handleAcceptAll() {
            if (currentMode === 'folder' && currentResults.files) {
                // æ–‡ä»¶å¤¹æ¨¡å¼ï¼šå¤„ç†æ‰€æœ‰æ–‡ä»¶çš„é”™è¯¯
                Object.keys(corrections).forEach(correctionKey => {
                    if (correctionKey.includes('-')) {
                        const [fileIndex, errorIndex] = correctionKey.split('-').map(Number);
                        acceptFileCorrection(fileIndex, errorIndex);
                    } else {
                        acceptCorrection(parseInt(correctionKey));
                    }
                });
            } else {
                // å•æ–‡ä»¶æ¨¡å¼
                Object.keys(corrections).forEach(index => {
                    acceptCorrection(parseInt(index));
                });
            }
        }

        function handleRejectAll() {
            if (currentMode === 'folder' && currentResults.files) {
                // æ–‡ä»¶å¤¹æ¨¡å¼ï¼šå¤„ç†æ‰€æœ‰æ–‡ä»¶çš„é”™è¯¯
                Object.keys(corrections).forEach(correctionKey => {
                    if (correctionKey.includes('-')) {
                        const [fileIndex, errorIndex] = correctionKey.split('-').map(Number);
                        rejectFileCorrection(fileIndex, errorIndex);
                    } else {
                        rejectCorrection(parseInt(correctionKey));
                    }
                });
            } else {
                // å•æ–‡ä»¶æ¨¡å¼
                Object.keys(corrections).forEach(index => {
                    rejectCorrection(parseInt(index));
                });
            }
        }

        function updateApplyButton() {
            const acceptedCount = Object.values(corrections).filter(c => c.accepted === true).length;
            
            if (acceptedCount > 0) {
                let existingBtn = document.getElementById('applyBtn');
                if (!existingBtn) {
                    const batchActions = document.getElementById('batchActions');
                    const applyBtn = document.createElement('button');
                    applyBtn.id = 'applyBtn';
                    applyBtn.className = 'batch-btn';
                    applyBtn.style.background = '#667eea';
                    applyBtn.onclick = handleApplyFixes;
                    batchActions.appendChild(applyBtn);
                    existingBtn = applyBtn;
                }
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                existingBtn.textContent = `ğŸ“ æ›¿æ¢ ${acceptedCount} ä¸ªæ–‡ä»¶`;
                existingBtn.style.display = 'inline-block';
            } else {
                // å¦‚æœæ²¡æœ‰æ¥å—çš„ä¿®æ­£ï¼Œéšè—æŒ‰é’®
                const existingBtn = document.getElementById('applyBtn');
                if (existingBtn) {
                    existingBtn.style.display = 'none';
                }
            }
        }

        async function handleApplyFixes() {
            if (currentMode === 'folder' && currentResults.files) {
                await handleFolderApplyFixes();
            } else {
                await handleSingleFileApplyFixes();
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šåº”ç”¨ä¿®æ­£åˆ°å†…å®¹
        function applyFixesToContent(content, fixes) {
            let modifiedContent = content;
            
            // æŒ‰ä½ç½®å€’åºæ’åˆ—ï¼Œé¿å…ä½ç½®åç§»
            const sortedFixes = fixes.sort((a, b) => b.position - a.position);
            
            for (const fix of sortedFixes) {
                if (fix.accepted && fix.fixed) {
                    modifiedContent = modifiedContent.substring(0, fix.position) + 
                                    fix.fixed + 
                                    modifiedContent.substring(fix.position + fix.original.length);
                }
            }
            
            return modifiedContent;
        }

        async function handleSingleFileApplyFixes() {
            const acceptedFixes = [];
            
            Object.keys(corrections).forEach(index => {
                if (corrections[index].accepted === true) {
                    const error = currentResults.errors[index];
                    acceptedFixes.push({
                        position: error.position,
                        original: error.raw,
                        fixed: corrections[index].fixed,
                        accepted: true
                    });
                }
            });

            if (acceptedFixes.length === 0) {
                showResult('error', 'æ²¡æœ‰æ¥å—çš„ä¿®æ­£');
                return;
            }

            try {
                let content, filename;
                
                if (currentMode === 'text') {
                    // æ–‡æœ¬æ¨¡å¼ï¼šç›´æ¥æ›´æ–°æ–‡æœ¬æ¡†å†…å®¹
                    content = document.getElementById('textInput').value;
                    filename = document.getElementById('textFilename').value.trim() || 'untitled.md';
                    
                    const modifiedContent = applyFixesToContent(content, acceptedFixes);
                    document.getElementById('textInput').value = modifiedContent;
                    showResult('success', `ä¿®æ­£å·²åº”ç”¨åˆ°æ–‡æœ¬æ¡†ï¼å…±åº”ç”¨ ${acceptedFixes.length} ä¸ªä¿®æ­£`);
                    return;
                } else {
                    // æ–‡ä»¶æ¨¡å¼ï¼šæ›¿æ¢åŸæ–‡ä»¶
                    if (!selectedFile) {
                        showResult('error', 'æ²¡æœ‰é€‰æ‹©çš„æ–‡ä»¶');
                        return;
                    }
                    
                    const reader = new FileReader();
                    content = await new Promise((resolve) => {
                        reader.onload = e => resolve(e.target.result);
                        reader.readAsText(selectedFile);
                    });
                    filename = selectedFile.name;
                }

                // è°ƒç”¨åç«¯APIè·å–ä¿®æ­£åçš„å†…å®¹
                const response = await fetch('/apply-fixes-browser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        fixes: acceptedFixes,
                        filename: filename
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // åˆ›å»ºæ–°çš„æ–‡ä»¶å¯¹è±¡å¹¶è§¦å‘ä¸‹è½½ï¼Œå®ç°"æ›¿æ¢"æ•ˆæœ
                    const blob = new Blob([result.content], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = filename;
                    downloadLink.style.display = 'none';
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(url);
                    
                    showResult('success', `æ–‡ä»¶å·²æ›´æ–°ï¼å…±åº”ç”¨ ${result.appliedFixes} ä¸ªä¿®æ­£ã€‚è¯·æŸ¥çœ‹ä¸‹è½½çš„æ–‡ä»¶`);
                } else {
                    throw new Error(result.message || 'åº”ç”¨ä¿®æ­£å¤±è´¥');
                }

            } catch (error) {
                showResult('error', 'åº”ç”¨ä¿®æ­£å¤±è´¥: ' + error.message);
            }
        }

        async function handleFolderApplyFixes() {
            // æŒ‰æ–‡ä»¶åˆ†ç»„æ•´ç†ä¿®æ­£
            const fileFixesMap = new Map();
            
            Object.keys(corrections).forEach(correctionKey => {
                if (corrections[correctionKey].accepted === true) {
                    if (correctionKey.includes('-')) {
                        // æ–‡ä»¶å¤¹æ¨¡å¼ï¼šfileIndex-errorIndex
                        const [fileIndex, errorIndex] = correctionKey.split('-').map(Number);
                        const file = currentResults.files[fileIndex];
                        const error = file.errors[errorIndex];
                        
                        if (!fileFixesMap.has(fileIndex)) {
                            fileFixesMap.set(fileIndex, {
                                file: file,
                                fixes: []
                            });
                        }
                        
                        fileFixesMap.get(fileIndex).fixes.push({
                            position: error.position,
                            original: error.raw,
                            fixed: corrections[correctionKey].fixed,
                            accepted: true
                        });
                    }
                }
            });

            if (fileFixesMap.size === 0) {
                showResult('error', 'æ²¡æœ‰æ¥å—çš„ä¿®æ­£');
                return;
            }

            try {
                const results = [];
                
                // å¤„ç†æ¯ä¸ªæœ‰ä¿®æ­£çš„æ–‡ä»¶
                for (const [fileIndex, fileData] of fileFixesMap) {
                    let content;
                    
                    if (window.selectedFolderFiles) {
                        // æµè§ˆå™¨é€‰æ‹©çš„æ–‡ä»¶ï¼šè¯»å–å†…å®¹å¹¶ä¸‹è½½æ›¿æ¢
                        const file = window.selectedFolderFiles.find(f => 
                            (f.webkitRelativePath || f.name) === fileData.file.path
                        );
                        
                        if (file) {
                            content = await readFileAsText(file);
                            
                            // ä½¿ç”¨æµè§ˆå™¨APIå¤„ç†æ–‡ä»¶æ›¿æ¢
                            const response = await fetch('/apply-fixes-browser', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    content: content,
                                    fixes: fileData.fixes,
                                    filename: file.name
                                })
                            });

                            const result = await response.json();
                            
                            if (result.success) {
                                // åˆ›å»ºä¸‹è½½é“¾æ¥å®ç°æ–‡ä»¶æ›¿æ¢
                                const blob = new Blob([result.content], { type: 'text/markdown' });
                                const url = URL.createObjectURL(blob);
                                const downloadLink = document.createElement('a');
                                downloadLink.href = url;
                                downloadLink.download = file.name;
                                downloadLink.style.display = 'none';
                                document.body.appendChild(downloadLink);
                                downloadLink.click();
                                document.body.removeChild(downloadLink);
                                URL.revokeObjectURL(url);
                                
                                results.push({
                                    originalFile: fileData.file.path,
                                    replaced: true,
                                    appliedFixes: result.appliedFixes
                                });
                            }
                        } else {
                            throw new Error(`æ— æ³•æ‰¾åˆ°æ–‡ä»¶: ${fileData.file.path}`);
                        }
                    } else {
                        // æœåŠ¡å™¨è·¯å¾„æ–‡ä»¶ï¼šç›´æ¥æ›¿æ¢åŸæ–‡ä»¶
                        const response = await fetch('/read-file', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                filePath: fileData.file.fullPath
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`æ— æ³•è¯»å–æ–‡ä»¶: ${fileData.file.path}`);
                        }
                        
                        const fileResult = await response.json();
                        content = fileResult.content;

                        // ç›´æ¥æ›¿æ¢åŸæ–‡ä»¶
                        const applyResponse = await fetch('/apply-fixes-inplace', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                content: content,
                                fixes: fileData.fixes,
                                filePath: fileData.file.fullPath,
                                mode: 'folder'
                            })
                        });

                        const applyResult = await applyResponse.json();
                        
                        if (applyResult.success) {
                            results.push({
                                originalFile: fileData.file.path,
                                replaced: true,
                                appliedFixes: applyResult.appliedFixes
                            });
                        } else {
                            console.error(`åº”ç”¨ä¿®æ­£å¤±è´¥ ${fileData.file.path}:`, applyResult.message);
                        }
                    }
                }

                if (results.length > 0) {
                    const totalFixes = results.reduce((sum, r) => sum + r.appliedFixes, 0);
                    const browserFiles = results.filter(r => window.selectedFolderFiles);
                    const serverFiles = results.filter(r => !window.selectedFolderFiles);
                    
                    if (browserFiles.length > 0 && serverFiles.length === 0) {
                        showResult('success', `æ–‡ä»¶å·²æ›´æ–°ï¼å…±å¤„ç† ${results.length} ä¸ªæ–‡ä»¶ï¼Œåº”ç”¨ ${totalFixes} ä¸ªä¿®æ­£ã€‚è¯·æŸ¥çœ‹ä¸‹è½½çš„æ–‡ä»¶`);
                    } else {
                        showResult('success', `æ–‡ä»¶å·²ç›´æ¥æ›´æ–°ï¼å…±å¤„ç† ${results.length} ä¸ªåŸæ–‡ä»¶ï¼Œåº”ç”¨ ${totalFixes} ä¸ªä¿®æ­£`);
                    }
                } else {
                    showResult('error', 'æ²¡æœ‰æˆåŠŸåº”ç”¨çš„ä¿®æ­£');
                }

            } catch (error) {
                showResult('error', 'æ‰¹é‡åº”ç”¨ä¿®æ­£å¤±è´¥: ' + error.message);
            }
        }

        function showResult(type, message) {
            const resultInfo = document.getElementById('resultInfo');
            resultInfo.className = `result-info ${type}`;
            resultInfo.innerHTML = message;
            resultInfo.style.display = 'block';

            setTimeout(() => {
                if (!resultInfo.querySelector('a')) {
                    resultInfo.style.display = 'none';
                }
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ===============================
        // LLM è®¾ç½®ç›¸å…³åŠŸèƒ½
        // ===============================
        
        // LLM é…ç½®æ•°æ®
        let llmConfigs = {
            lmstudio: {
                endpoint: 'http://localhost:1234',
                model: 'qwen/qwen3-4b-thinking-2507',
                prompt: 'æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼'
            },
            ollama: {
                endpoint: 'http://localhost:11434',
                model: 'qwen2.5:7b',
                prompt: 'æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼'
            },
            openai: {
                endpoint: 'https://api.openai.com',
                model: 'gpt-3.5-turbo',
                apikey: '',
                prompt: 'æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼'
            }
        };
        
        function setupLLMSettingsEventListeners() {
            // è®¾ç½®æŒ‰é’®
            document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
            
            // æ¨¡æ€æ¡†å…³é—­
            document.getElementById('closeModal').addEventListener('click', closeSettingsModal);
            document.getElementById('settingsModal').addEventListener('click', function(e) {
                if (e.target === this) closeSettingsModal();
            });
            
            // é€‰é¡¹å¡åˆ‡æ¢
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchSettingsTab(this.dataset.tab);
                });
            });
            
            // åˆ·æ–°æ¨¡å‹æŒ‰é’®
            document.querySelectorAll('.refresh-models-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    refreshModels(this.dataset.provider);
                });
            });
            
            // æµ‹è¯•è¿æ¥æŒ‰é’®
            document.querySelectorAll('.test-connection-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    testConnection(this.dataset.provider);
                });
            });
            
            // ä¿å­˜è®¾ç½®
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            
            // é‡ç½®è®¾ç½®
            document.getElementById('resetSettings').addEventListener('click', resetSettings);
            
            // åŠ è½½ä¿å­˜çš„è®¾ç½®
            loadSettings();
        }
        
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('show');
            // åˆ·æ–°å½“å‰è®¾ç½®åˆ°ç•Œé¢
            refreshSettingsUI();
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }
        
        function switchSettingsTab(tab) {
            // æ›´æ–°é€‰é¡¹å¡çŠ¶æ€
            document.querySelectorAll('.settings-tabs .tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            // åˆ‡æ¢å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `tab-${tab}`);
            });
        }
        
        async function refreshModels(provider) {
            const btn = document.querySelector(`[data-provider="${provider}"].refresh-models-btn`);
            const select = document.getElementById(`${provider}-model`);
            
            btn.disabled = true;
            btn.textContent = 'â³';
            
            try {
                const config = getCurrentConfig(provider);
                
                const response = await fetch('/get-models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: provider,
                        config: config
                    })
                });
                
                const result = await response.json();
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                select.innerHTML = '';
                
                if (result.success && result.models && result.models.length > 0) {
                    result.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        select.appendChild(option);
                    });
                    
                    // å¦‚æœæœ‰ä¿å­˜çš„æ¨¡å‹ï¼Œå°è¯•é€‰ä¸­
                    if (llmConfigs[provider].model && result.models.includes(llmConfigs[provider].model)) {
                        select.value = llmConfigs[provider].model;
                    }
                } else {
                    const option = document.createElement('option');
                    option.value = llmConfigs[provider].model;
                    option.textContent = llmConfigs[provider].model;
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                // ä¿ç•™é»˜è®¤é€‰é¡¹
                select.innerHTML = `<option value="${llmConfigs[provider].model}">${llmConfigs[provider].model}</option>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸ”„';
            }
        }
        
        async function testConnection(provider) {
            const btn = document.querySelector(`[data-provider="${provider}"].test-connection-btn`);
            const status = document.getElementById(`${provider}-status`);
            
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';
            status.className = 'status-indicator testing';
            status.textContent = 'æµ‹è¯•ä¸­...';
            
            try {
                const config = getCurrentConfig(provider);
                
                const response = await fetch('/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: provider,
                        config: config
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    status.className = 'status-indicator connected';
                    status.textContent = 'è¿æ¥æˆåŠŸ';
                } else {
                    status.className = 'status-indicator disconnected';
                    status.textContent = result.message || 'è¿æ¥å¤±è´¥';
                }
            } catch (error) {
                status.className = 'status-indicator disconnected';
                status.textContent = 'è¿æ¥é”™è¯¯';
                console.error(`æµ‹è¯• ${provider} è¿æ¥å¤±è´¥:`, error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'æµ‹è¯•è¿æ¥';
            }
        }
        
        function getCurrentConfig(provider) {
            return {
                endpoint: document.getElementById(`${provider}-endpoint`).value,
                model: document.getElementById(`${provider}-model`).value,
                apikey: provider === 'openai' ? document.getElementById(`${provider}-apikey`).value : undefined,
                prompt: document.getElementById(`${provider}-prompt`).value
            };
        }
        
        function saveSettings() {
            // æ”¶é›†æ‰€æœ‰è®¾ç½®
            ['lmstudio', 'ollama', 'openai'].forEach(provider => {
                llmConfigs[provider] = getCurrentConfig(provider);
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('llmConfigs', JSON.stringify(llmConfigs));
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæ¶ˆæ¯
            showResult('success', 'è®¾ç½®å·²ä¿å­˜');
            
            // å…³é—­æ¨¡æ€æ¡†
            closeSettingsModal();
        }
        
        function resetSettings() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰é…ç½®ã€‚')) {
                // é‡ç½®ä¸ºé»˜è®¤å€¼
                llmConfigs = {
                    lmstudio: {
                        endpoint: 'http://localhost:1234',
                        model: 'qwen/qwen3-4b-thinking-2507',
                        prompt: 'æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼'
                    },
                    ollama: {
                        endpoint: 'http://localhost:11434',
                        model: 'qwen2.5:7b',
                        prompt: 'æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼'
                    },
                    openai: {
                        endpoint: 'https://api.openai.com',
                        model: 'gpt-3.5-turbo',
                        apikey: '',
                        prompt: 'æ ¹æ®è¾“å…¥çš„latexå’Œkatexè§£ææŠ¥é”™,è¾“å‡ºä¿®æ­£è¿‡åçš„latexå…¬å¼,ä¸è¦è¾“å‡ºå…¶ä»–ä»»ä½•ä¸œè¥¿,åªè¦ä¿®æ­£åçš„å…¬å¼'
                    }
                };
                
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                localStorage.removeItem('llmConfigs');
                
                // åˆ·æ–°ç•Œé¢
                refreshSettingsUI();
                
                showResult('success', 'è®¾ç½®å·²é‡ç½®');
            }
        }
        
        function loadSettings() {
            try {
                const saved = localStorage.getItem('llmConfigs');
                if (saved) {
                    const savedConfigs = JSON.parse(saved);
                    // åˆå¹¶è®¾ç½®ï¼Œä¿ç•™é»˜è®¤å€¼
                    Object.keys(llmConfigs).forEach(provider => {
                        if (savedConfigs[provider]) {
                            llmConfigs[provider] = { ...llmConfigs[provider], ...savedConfigs[provider] };
                        }
                    });
                }
            } catch (error) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
            }
            
            refreshSettingsUI();
        }
        
        function refreshSettingsUI() {
            ['lmstudio', 'ollama', 'openai'].forEach(provider => {
                const config = llmConfigs[provider];
                document.getElementById(`${provider}-endpoint`).value = config.endpoint || '';
                document.getElementById(`${provider}-model`).value = config.model || '';
                document.getElementById(`${provider}-prompt`).value = config.prompt || '';
                
                if (provider === 'openai') {
                    document.getElementById(`${provider}-apikey`).value = config.apikey || '';
                }
                
                // é‡ç½®çŠ¶æ€æŒ‡ç¤ºå™¨
                const status = document.getElementById(`${provider}-status`);
                status.className = 'status-indicator disconnected';
                status.textContent = 'æœªè¿æ¥';
            });
        }
        
        // è·å–å½“å‰é€‰ä¸­çš„æä¾›å•†é…ç½®
        function getCurrentProviderConfig() {
            const selectedProvider = document.querySelector('input[name="provider"]:checked').value;
            return {
                provider: selectedProvider,
                config: llmConfigs[selectedProvider]
            };
        }
    </script>
</body>
</html>